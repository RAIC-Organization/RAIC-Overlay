# GitHub Release Workflow
# Triggers on semantic version tags and creates a GitHub release with MSI installer

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - '*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: windows-latest

    steps:
      # T003: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # T004: Extract version from tag (strip 'v' prefix if present)
      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Extracted version: $version"

      # T005: Setup Node.js with npm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # T006: Setup Rust toolchain
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # T007: Cache Rust dependencies
      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      # T009-T011: Update version in all config files
      - name: Update version in config files
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Update tauri.conf.json
          $tauriConf = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $tauriConf.version = $version
          $tauriConf | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json
          echo "Updated tauri.conf.json to version $version"

          # Update package.json
          $packageJson = Get-Content package.json | ConvertFrom-Json
          $packageJson.version = $version
          $packageJson | ConvertTo-Json -Depth 10 | Set-Content package.json
          echo "Updated package.json to version $version"

          # Update Cargo.toml (regex replace for TOML)
          $cargoToml = Get-Content src-tauri/Cargo.toml -Raw
          $cargoToml = $cargoToml -replace '(?m)^version = ".*"', "version = `"$version`""
          Set-Content src-tauri/Cargo.toml $cargoToml -NoNewline
          echo "Updated Cargo.toml to version $version"

      # T012: Install frontend dependencies
      - name: Install frontend dependencies
        run: npm ci

      # T013: Build frontend
      - name: Build frontend
        run: npm run build

      # T014: Build Tauri application with MSI
      - name: Build Tauri release
        run: npm run tauri build

      # T014b: Verify MSI was created
      - name: Verify MSI artifact exists
        shell: pwsh
        run: |
          $msiFiles = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi" -ErrorAction SilentlyContinue
          if ($null -eq $msiFiles -or $msiFiles.Count -eq 0) {
            Write-Error "::error::MSI installer was not generated. Check Tauri build output for errors."
            exit 1
          }
          echo "Found MSI artifact(s):"
          $msiFiles | ForEach-Object { echo "  - $($_.Name)" }

      # T015-T018: Create GitHub release with MSI attachment
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: RAIC Overlay ${{ github.ref_name }}
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            src-tauri/target/release/bundle/msi/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # T021: Summary output for debugging
      - name: Release summary
        if: always()
        shell: pwsh
        run: |
          echo "## Release Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.ref_name }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.VERSION }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ contains(github.ref_name, '-') }}" >> $env:GITHUB_STEP_SUMMARY
